#!/usr/bin/env coffee

require 'rc'

require 'shelljs/global'

minimist = require 'minimist'

{ keys } = Object

{ resolve, dirname, sep } = require 'path'

{ parallel } = require 'async'

args = minimist process.argv.slice 2

{ src, dest, filename, link, fields } = args

cwd = pwd()

src ?= "."

src = resolve src

link ?= true

fields ?= ["dependencies", "devDependencies"]

filename ?= "package.json"

regexp = new RegExp "#{src.split(sep).join('\\'+sep)}\\#{sep}([\\w|\\-]+\\#{sep})?#{filename}$"

if typeof dest is "undefined"

  npmrc = require('rc')('npm');

  dest = npmrc.root

packages = {}

dependencies = {}

find(src).map (file) ->

  if not regexp.test file then return null

  folder = dirname file

  file = JSON.parse cat file

  deps = []

  fields.map (field) ->

    deps = deps.concat keys(file?[field] or {})

  deps.map (dependency) ->

    if not test "-e", resolve dest, dependency

      dependencies[dependency] = true

  packages[folder] = deps

# parallel
# console.log packages, dependencies
